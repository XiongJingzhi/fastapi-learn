"""
é˜¶æ®µ 2.5: ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ

å­¦ä¹ ç›®æ ‡:
1. è¯†åˆ«å¸¸è§çš„ DI åæ¨¡å¼
2. æŒæ¡æµ‹è¯•ä¸­çš„ä¾èµ–æ³¨å…¥
3. å­¦ä¹ æ€§èƒ½ä¼˜åŒ–æŠ€å·§
4. ç†è§£ä¾èµ–æ³¨å…¥çš„æ­£ç¡®ä½¿ç”¨æ–¹å¼
5. é¿å…å¸¸è§é™·é˜±

è¿è¡Œæ–¹å¼:
    uvicorn study.level2.examples.05_best_practices:app --reload
"""

from typing import Optional
from datetime import datetime
from fastapi import FastAPI, Depends, HTTPException, status
from pydantic import BaseModel, Field

app = FastAPI(
    title="ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ",
    description="æ¼”ç¤º DI çš„æ­£ç¡®ç”¨æ³•å’Œå¸¸è§é™·é˜±",
    version="2.0.0"
)


# ==================== åæ¨¡å¼ 1: æœåŠ¡å®šä½å™¨ ====================

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âŒ åæ¨¡å¼ï¼šæœåŠ¡å®šä½å™¨ (Service Locator)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class ServiceLocator:
    """
    âŒ åæ¨¡å¼ï¼šæœåŠ¡å®šä½å™¨

    é—®é¢˜ï¼š
    - éšå¼ä¾èµ–ï¼ˆçœ‹æ„é€ å‡½æ•°ä¸çŸ¥é“éœ€è¦ä»€ä¹ˆï¼‰
    - éš¾ä»¥æµ‹è¯•ï¼ˆéœ€è¦è®¾ç½®å…¨å±€çŠ¶æ€ï¼‰
    - è¿åä¾èµ–æ³¨å…¥åŸåˆ™
    """

    _instance = None

    def __init__(self):
        self._services = {}

    @classmethod
    def get_instance(cls):
        if cls._instance is None:
            cls._instance = cls()
        return cls._instance

    def register(self, name: str, service):
        self._services[name] = service

    def get(self, name: str):
        return self._services.get(name)


class BadUserService:
    """âŒ ä½¿ç”¨æœåŠ¡å®šä½å™¨ï¼ˆé”™è¯¯ç¤ºä¾‹ï¼‰"""

    def __init__(self):
        # âŒ ä¸»åŠ¨è·å–ä¾èµ–ï¼Œè€Œä¸æ˜¯è¢«æ³¨å…¥
        self.db = ServiceLocator.get_instance().get("database")

    async def get_user(self, user_id: int):
        return await self.db.query(f"SELECT * FROM users WHERE id = {user_id}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… æ­£ç¡®åšæ³•ï¼šä¾èµ–æ³¨å…¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class Database:
    """æ¨¡æ‹Ÿæ•°æ®åº“"""
    async def query(self, sql: str):
        return {"id": 1, "name": "Alice"}


class GoodUserService:
    """âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼ˆæ­£ç¡®ç¤ºä¾‹ï¼‰"""

    def __init__(self, db: Database):
        # âœ… ä¾èµ–é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥
        self.db = db

    async def get_user(self, user_id: int):
        return await self.db.query(f"SELECT * FROM users WHERE id = {user_id}")


def get_database() -> Database:
    return Database()


def get_good_user_service(
    db: Database = Depends(get_database)
) -> GoodUserService:
    """âœ… æ­£ç¡®çš„ä¾èµ–æä¾›è€…"""
    return GoodUserService(db)


@app.get("/pattern/anti-vs-pro")
async def compare_patterns(
    good_service: GoodUserService = Depends(get_good_user_service)
):
    """
    åæ¨¡å¼ vs æ­£ç¡®åšæ³•

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    âŒ æœåŠ¡å®šä½å™¨ï¼ˆåæ¨¡å¼ï¼‰
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class BadUserService:
        def __init__(self):
            self.db = ServiceLocator.get().get("database")  # ä¸»åŠ¨è·å–

    é—®é¢˜ï¼š
    - ä¾èµ–å…³ç³»ä¸æ˜ç¡®
    - éš¾ä»¥æµ‹è¯•ï¼ˆéœ€è¦è®¾ç½® ServiceLocatorï¼‰
    - éšå¼ä¾èµ–

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    âœ… ä¾èµ–æ³¨å…¥ï¼ˆæ­£ç¡®ï¼‰
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class GoodUserService:
        def __init__(self, db: Database):  # æ˜ç¡®çš„ä¾èµ–
            self.db = db

    ä¼˜åŠ¿ï¼š
    - ä¾èµ–æ˜ç¡®ï¼ˆçœ‹æ„é€ å‡½æ•°å°±çŸ¥é“ï¼‰
    - æ˜“äºæµ‹è¯•ï¼ˆæ³¨å…¥ Mockï¼‰
    - æ˜¾å¼ä¾èµ–

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    return {
        "anti_pattern": {
            "name": "æœåŠ¡å®šä½å™¨",
            "problems": [
                "éšå¼ä¾èµ–",
                "éš¾ä»¥æµ‹è¯•",
                "è¿å DI åŸåˆ™"
            ]
        },
        "best_practice": {
            "name": "ä¾èµ–æ³¨å…¥",
            "benefits": [
                "ä¾èµ–æ˜ç¡®",
                "æ˜“äºæµ‹è¯•",
                "æ˜¾å¼ä¾èµ–"
            ]
        },
        "example": good_service
    }


# ==================== åæ¨¡å¼ 2: è¿‡åº¦æ³¨å…¥ ====================

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âŒ åæ¨¡å¼ï¼šæ³¨å…¥è¿‡å¤šä¾èµ–
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class GodUserService:
    """
    âŒ åæ¨¡å¼ï¼šä¸Šå¸æœåŠ¡ï¼ˆæ³¨å…¥å¤ªå¤šä¾èµ–ï¼‰

    é—®é¢˜ï¼š
    - èŒè´£è¿‡å¤š
    - éš¾ä»¥ç»´æŠ¤
    - è¿åå•ä¸€èŒè´£åŸåˆ™
    """

    def __init__(
        self,
        db: Database,
        cache: Database,
        email_service: object,
        sms_service: object,
        notification_service: object,
        logger: object,
        audit_log: object,
        metrics: object,
        config: object
    ):
        # å¤ªå¤šä¾èµ–ï¼
        self.db = db
        self.cache = cache
        self.email_service = email_service
        self.sms_service = sms_service
        self.notification_service = notification_service
        self.logger = logger
        self.audit_log = audit_log
        self.metrics = metrics
        self.config = config

    async def create_user(self, user_data: dict):
        # å¤„ç†æ‰€æœ‰äº‹æƒ…...
        pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… æ­£ç¡®åšæ³•ï¼šæ‹†åˆ†æœåŠ¡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class NotificationService:
    """é€šçŸ¥æœåŠ¡ï¼ˆèŒè´£å•ä¸€ï¼‰"""

    def __init__(self, email_service, sms_service):
        self.email = email_service
        self.sms = sms_service


class UserAuditService:
    """ç”¨æˆ·å®¡è®¡æœåŠ¡ï¼ˆèŒè´£å•ä¸€ï¼‰"""

    def __init__(self, logger, audit_log):
        self.logger = logger
        self.audit_log = audit_log


class CleanUserService:
    """
    âœ… æ¸…æ™°çš„æœåŠ¡ï¼ˆèŒè´£å•ä¸€ï¼‰

    åªä¾èµ–å¿…è¦çš„ç»„ä»¶
    """

    def __init__(
        self,
        db: Database,
        notification: NotificationService
    ):
        # âœ… åªä¾èµ– 2 ä¸ªæ ¸å¿ƒç»„ä»¶
        self.db = db
        self.notification = notification

    async def create_user(self, user_data: dict):
        # ä¸“æ³¨äºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
        user = await self.db.insert(user_data)
        await self.notification.send_welcome(user)
        return user


@app.get("/pattern/over-injection")
async def demonstrate_over_injection():
    """
    è¿‡åº¦æ³¨å…¥ vs èŒè´£å•ä¸€

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    âŒ ä¸Šå¸æœåŠ¡ï¼ˆè¿‡åº¦æ³¨å…¥ï¼‰
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class GodUserService:
        def __init__(
            self,
            db, cache, email, sms, notification,
            logger, audit, metrics, config  # 9 ä¸ªä¾èµ–ï¼
        ):
            ...

    é—®é¢˜ï¼š
    - èŒè´£è¿‡å¤š
    - éš¾ä»¥ç»´æŠ¤
    - éš¾ä»¥æµ‹è¯•
    - è¿åå•ä¸€èŒè´£åŸåˆ™

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    âœ… èŒè´£å•ä¸€ï¼ˆæ­£ç¡®ï¼‰
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class CleanUserService:
        def __init__(self, db, notification):  # 2 ä¸ªä¾èµ–
            ...

    ä¼˜åŠ¿ï¼š
    - èŒè´£æ¸…æ™°
    - æ˜“äºç»´æŠ¤
    - æ˜“äºæµ‹è¯•
    - ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    return {
        "anti_pattern": {
            "name": "è¿‡åº¦æ³¨å…¥",
            "example": "GodUserService(db, cache, email, sms, ...)",
            "problems": [
                "èŒè´£è¿‡å¤š",
                "éš¾ä»¥ç»´æŠ¤",
                "è¿åå•ä¸€èŒè´£åŸåˆ™"
            ]
        },
        "best_practice": {
            "name": "èŒè´£å•ä¸€",
            "example": "CleanUserService(db, notification)",
            "benefits": [
                "èŒè´£æ¸…æ™°",
                "æ˜“äºç»´æŠ¤",
                "ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™"
            ]
        },
        "rule": "ä¸€ä¸ªæœåŠ¡çš„ä¾èµ–ä¸åº”è¯¥è¶…è¿‡ 5 ä¸ª"
    }


# ==================== æœ€ä½³å®è·µ 1: æµ‹è¯•ä¸­çš„ä¾èµ–æ³¨å…¥ ====================

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… æœ€ä½³å®è·µï¼šæµ‹è¯•ä¸­ä½¿ç”¨ Mock
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class UserService:
    """ç”¨æˆ·æœåŠ¡"""

    def __init__(self, repo):
        self.repo = repo

    async def get_user(self, user_id: int):
        return await self.repo.find_by_id(user_id)


class MockUserRepository:
    """
    âœ… Mock ä»“å‚¨ï¼ˆç”¨äºæµ‹è¯•ï¼‰

    ä¼˜åŠ¿ï¼š
    - ä¸éœ€è¦çœŸå®æ•°æ®åº“
    - æµ‹è¯•é€Ÿåº¦å¿«
    - å¯ä»¥æ¨¡æ‹Ÿå„ç§åœºæ™¯
    """

    def __init__(self):
        self._data = {
            1: {"id": 1, "name": "Alice"},
            2: {"id": 2, "name": "Bob"},
        }

    async def find_by_id(self, user_id: int):
        return self._data.get(user_id)


def get_user_service_for_testing():
    """
    æµ‹è¯•ç”¨çš„ä¾èµ–æä¾›è€…

    ğŸ’¡ è¿”å›ä½¿ç”¨ Mock çš„æœåŠ¡
    """
    mock_repo = MockUserRepository()
    return UserService(mock_repo)


@app.get("/testing/demo")
async def testing_demo(
    service: UserService = Depends(get_user_service_for_testing)
):
    """
    æµ‹è¯•æ¼”ç¤º

    ğŸ” å…³é”®ç‚¹ï¼š
    - æœåŠ¡å±‚ä»£ç ä¸éœ€è¦ä¿®æ”¹
    - åªéœ€è¦æ³¨å…¥ä¸åŒçš„ä¾èµ–
    - è¿™æ˜¯ä¾èµ–æ³¨å…¥çš„å¨åŠ›ï¼

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    æµ‹è¯•ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # æµ‹è¯•æ—¶æ³¨å…¥ Mock
    async def test_get_user():
        mock_repo = MockUserRepository()
        service = UserService(mock_repo)  # æ³¨å…¥ Mock

        user = await service.get_user(1)
        assert user["name"] == "Alice"

    âœ… ä¼˜åŠ¿ï¼š
    - ä¸éœ€è¦å¯åŠ¨ HTTP æœåŠ¡å™¨
    - ä¸éœ€è¦è¿æ¥æ•°æ®åº“
    - æµ‹è¯•é€Ÿåº¦å¿«
    - å¯ä»¥æ¨¡æ‹Ÿå„ç§åœºæ™¯

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    user = await service.get_user(1)

    return {
        "user": user,
        "note": "è¿™ä¸ªæœåŠ¡ä½¿ç”¨çš„æ˜¯ Mock ä»“å‚¨",
        "benefits": [
            "ä¸éœ€è¦çœŸå®æ•°æ®åº“",
            "æµ‹è¯•é€Ÿåº¦å¿«",
            "å¯ä»¥æ¨¡æ‹Ÿå„ç§åœºæ™¯"
        ]
    }


# ==================== æœ€ä½³å®è·µ 2: æ€§èƒ½ä¼˜åŒ– ====================

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… æœ€ä½³å®è·µï¼šåˆ©ç”¨ä¾èµ–ç¼“å­˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class ExpensiveService:
    """
    æ˜‚è´µçš„èµ„æº

    ğŸ’¡ æ¨¡æ‹Ÿä¸€ä¸ªåˆå§‹åŒ–æˆæœ¬é«˜çš„æœåŠ¡
    """

    def __init__(self):
        import time
        time.sleep(0.1)  # æ¨¡æ‹Ÿè€—æ—¶åˆå§‹åŒ–
        self.created_at = datetime.now()
        self.instance_id = id(self)

    def do_work(self):
        return {"result": "work done"}


def get_expensive_service() -> ExpensiveService:
    """è·å–æ˜‚è´µæœåŠ¡ï¼ˆä¼šè¢«ç¼“å­˜ï¼‰"""
    return ExpensiveService()


@app.get("/performance/cache")
async def demo_performance_cache(
    service1: ExpensiveService = Depends(get_expensive_service),
    service2: ExpensiveService = Depends(get_expensive_service),
    service3: ExpensiveService = Depends(get_expensive_service)
):
    """
    æ€§èƒ½ä¼˜åŒ–æ¼”ç¤º

    ğŸ” FastAPI çš„ä¾èµ–ç¼“å­˜ï¼š
    - åŒä¸€ä¸ªè¯·æ±‚ä¸­
    - å¤šæ¬¡ä½¿ç”¨åŒä¸€ä¸ªä¾èµ–
    - åªåˆ›å»ºä¸€æ¬¡å®ä¾‹
    - service1, service2, service3 æ˜¯åŒä¸€ä¸ªå¯¹è±¡

    âœ… æ€§èƒ½æå‡ï¼š
    - é¿å…é‡å¤åˆ›å»º
    - èŠ‚çœèµ„æº
    - æé«˜å“åº”é€Ÿåº¦

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    å®é™…åœºæ™¯
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    æ•°æ®åº“è¿æ¥æ± ï¼š
    - åˆ›å»ºæˆæœ¬é«˜
    - åŒä¸€ä¸ªè¯·æ±‚å…±äº«è¿æ¥
    - é¿å…é‡å¤å»ºç«‹è¿æ¥

    ç¼“å­˜æœåŠ¡ï¼š
    - åˆå§‹åŒ–éœ€è¦åŠ è½½é…ç½®
    - åŒä¸€ä¸ªè¯·æ±‚å…±äº«å®ä¾‹
    - é¿å…é‡å¤åŠ è½½

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    is_same = (
        service1 is service2 and
        service2 is service3
    )

    return {
        "cached": is_same,
        "instance_id": id(service1),
        "created_at": service1.created_at.isoformat(),
        "note": "ä¸‰ä¸ªå˜é‡æŒ‡å‘åŒä¸€ä¸ªå®ä¾‹",
        "performance_tip": "åˆ©ç”¨ç¼“å­˜é¿å…é‡å¤åˆ›å»ºæ˜‚è´µèµ„æº"
    }


# ==================== æœ€ä½³å®è·µ 3: ä¾èµ–ç»„ç»‡ ====================

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… æœ€ä½³å®è·µï¼šåˆç†ç»„ç»‡ä¾èµ–
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


# åŸºç¡€ä¾èµ–
def get_config():
    """è·å–é…ç½®ï¼ˆæœ€åº•å±‚ï¼‰"""
    return {"debug": True, "log_level": "INFO"}


# ä¾èµ–é…ç½®
def get_logger(config: dict = Depends(get_config)):
    """è·å–æ—¥å¿—å™¨ï¼ˆä¾èµ–é…ç½®ï¼‰"""
    return {"level": config["log_level"]}


# ä¾èµ–æ—¥å¿—å™¨
def get_database(config: dict = Depends(get_config)):
    """è·å–æ•°æ®åº“ï¼ˆä¾èµ–é…ç½®ï¼‰"""
    return {"connection": f"db_{config['debug']}"}


# ä¾èµ–æ•°æ®åº“
def get_repo(db: dict = Depends(get_database)):
    """è·å–ä»“å‚¨ï¼ˆä¾èµ–æ•°æ®åº“ï¼‰"""
    return {"db": db}


# ä¾èµ–ä»“å‚¨å’Œæ—¥å¿—å™¨
def get_user_service(
    repo: dict = Depends(get_repo),
    logger: dict = Depends(get_logger)
):
    """è·å–ç”¨æˆ·æœåŠ¡ï¼ˆä¾èµ–ä»“å‚¨å’Œæ—¥å¿—å™¨ï¼‰"""
    return {"repo": repo, "logger": logger}


@app.get("/organization/demo")
async def demo_organization(
    service: dict = Depends(get_user_service)
):
    """
    ä¾èµ–ç»„ç»‡æ¼”ç¤º

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ä¾èµ–å±‚æ¬¡ç»“æ„
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    config (é…ç½®)
        â†“
        â”œâ”€â†’ logger (æ—¥å¿—å™¨)
        â”‚       â†“
        â”‚   service (æœåŠ¡)
        â”‚
        â””â”€â†’ database (æ•°æ®åº“)
                â†“
            repo (ä»“å‚¨)
                â†“
            service (æœåŠ¡)

    âœ… ç»„ç»‡åŸåˆ™ï¼š
    1. åŸºç¡€ä¾èµ–åœ¨åº•éƒ¨
    2. é«˜å±‚ä¾èµ–ä¾èµ–ä½å±‚ä¾èµ–
    3. æ¸…æ™°çš„å±‚æ¬¡ç»“æ„
    4. é¿å…å¾ªç¯ä¾èµ–

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    return {
        "service": service,
        "structure": {
            "level_1": "config (é…ç½®)",
            "level_2": "logger, database (æ—¥å¿—å™¨ã€æ•°æ®åº“)",
            "level_3": "repo (ä»“å‚¨)",
            "level_4": "service (æœåŠ¡)"
        },
        "tips": [
            "åŸºç¡€ä¾èµ–åœ¨åº•éƒ¨",
            "é«˜å±‚ä¾èµ–ä½å±‚",
            "é¿å…å¾ªç¯ä¾èµ–",
            "ä¿æŒå±‚æ¬¡æ¸…æ™°"
        ]
    }


# ==================== æœ€ä½³å®è·µ 4: é”™è¯¯å¤„ç† ====================

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… æœ€ä½³å®è·µï¼šä¾èµ–ä¸­çš„é”™è¯¯å¤„ç†
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


class ConfigError(Exception):
    """é…ç½®é”™è¯¯"""
    pass


def get_database_safe():
    """
    å®‰å…¨çš„æ•°æ®åº“è¿æ¥è·å–

    ğŸ’¡ åœ¨ä¾èµ–ä¸­è¿›è¡ŒéªŒè¯
    """
    config = {"db_url": None}  # æ¨¡æ‹Ÿé…ç½®

    if not config.get("db_url"):
        # âœ… åœ¨ä¾èµ–ä¸­æŠ›å‡ºæ¸…æ™°çš„é”™è¯¯
        raise HTTPException(
            status_code=500,
            detail="æ•°æ®åº“é…ç½®ç¼ºå¤±"
        )

    return {"connection": config["db_url"]}


@app.get("/error-handling/demo", status_code=500)
async def demo_error_handling():
    """
    é”™è¯¯å¤„ç†æ¼”ç¤º

    ğŸ” è®¿é—®è¿™ä¸ªç«¯ç‚¹ä¼šè§¦å‘é”™è¯¯

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    âœ… æœ€ä½³å®è·µï¼š
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    1. åœ¨ä¾èµ–ä¸­è¿›è¡ŒéªŒè¯
       - é…ç½®æ˜¯å¦å®Œæ•´
       - èµ„æºæ˜¯å¦å¯ç”¨
       - æƒé™æ˜¯å¦è¶³å¤Ÿ

    2. æŠ›å‡ºæ¸…æ™°çš„é”™è¯¯
       - HTTPException
       - æ˜ç¡®çš„çŠ¶æ€ç 
       - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

    3. ä½¿ç”¨ yield ç¡®ä¿æ¸…ç†
       - å³ä½¿å‡ºé”™ä¹Ÿä¼šæ‰§è¡Œ
       - é¿å…èµ„æºæ³„æ¼

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    # è¿™ä¸ªç«¯ç‚¹ä¼šè§¦å‘é”™è¯¯
    db = Depends(get_database_safe)
    return {"note": "ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ"}


# ==================== æ€»ç»“ ====================

@app.get("/best-practices/summary")
async def best_practices_summary():
    """
    æœ€ä½³å®è·µæ€»ç»“

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    âœ… åº”è¯¥åšçš„
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    1. ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼ˆä¸æ˜¯æœåŠ¡å®šä½å™¨ï¼‰
       class Service:
           def __init__(self, repo):  # âœ… æ˜ç¡®çš„ä¾èµ–
               self.repo = repo

    2. ä¿æŒæœåŠ¡èŒè´£å•ä¸€
       class UserService:  # âœ… åªåšç”¨æˆ·ç›¸å…³çš„äº‹
           def __init__(self, repo):
               self.repo = repo

    3. åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ Mock
       mock_repo = MockRepo()
       service = UserService(mock_repo)  # âœ… æ˜“äºæµ‹è¯•

    4. åˆ©ç”¨ä¾èµ–ç¼“å­˜
       # âœ… åŒä¸€ä¸ªè¯·æ±‚ä¸­ï¼Œä¾èµ–åªåˆ›å»ºä¸€æ¬¡

    5. åˆç†ç»„ç»‡ä¾èµ–å±‚æ¬¡
       # âœ… åŸºç¡€ä¾èµ– â†’ é«˜å±‚ä¾èµ–

    6. åœ¨ä¾èµ–ä¸­è¿›è¡ŒéªŒè¯
       def get_db():
           if not config.db_url:
               raise HTTPException(...)  # âœ… æ—©æœŸå¤±è´¥

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    âŒ ä¸åº”è¯¥åšçš„
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    1. ä¸è¦ä½¿ç”¨æœåŠ¡å®šä½å™¨
       self.repo = ServiceLocator.get("repo")  # âŒ éšå¼ä¾èµ–

    2. ä¸è¦æ³¨å…¥è¿‡å¤šä¾èµ–
       def __init__(self, db, cache, email, sms, ...):  # âŒ å¤ªå¤šäº†

    3. ä¸è¦åœ¨ä¾èµ–ä¸­åšé‡æ“ä½œ
       def get_dep():
           time.sleep(10)  # âŒ å¤ªæ…¢äº†

    4. ä¸è¦å¾ªç¯ä¾èµ–
       A â†’ B â†’ A  # âŒ æ­»å¾ªç¯

    5. ä¸è¦åœ¨ä¾èµ–ä¸­è®¿é—®å…¨å±€çŠ¶æ€
       global_state  # âŒ éš¾ä»¥æµ‹è¯•

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    return {
        "do_s": {
            "use_di": "ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼ˆä¸æ˜¯æœåŠ¡å®šä½å™¨ï¼‰",
            "single_responsibility": "ä¿æŒæœåŠ¡èŒè´£å•ä¸€",
            "use_mocks": "åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ Mock",
            "leverage_cache": "åˆ©ç”¨ä¾èµ–ç¼“å­˜",
            "organize_well": "åˆç†ç»„ç»‡ä¾èµ–å±‚æ¬¡",
            "validate_early": "åœ¨ä¾èµ–ä¸­è¿›è¡ŒéªŒè¯"
        },
        "dont_s": {
            "no_service_locator": "ä¸è¦ä½¿ç”¨æœåŠ¡å®šä½å™¨",
            "no_over_injection": "ä¸è¦æ³¨å…¥è¿‡å¤šä¾èµ–",
            "no_heavy_ops": "ä¸è¦åœ¨ä¾èµ–ä¸­åšé‡æ“ä½œ",
            "no_circular_deps": "ä¸è¦å¾ªç¯ä¾èµ–",
            "no_global_state": "ä¸è¦åœ¨ä¾èµ–ä¸­è®¿é—®å…¨å±€çŠ¶æ€"
        },
        "rules": [
            "ä¾èµ–ä¸è¶…è¿‡ 5 ä¸ª",
            "ä½¿ç”¨æ¥å£ï¼ˆæŠ½è±¡ï¼‰è€Œä¸æ˜¯å…·ä½“å®ç°",
            "åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å…¥ï¼ˆè€Œä¸æ˜¯ setterï¼‰",
            "ä½¿ç”¨ yield ç®¡ç†èµ„æº",
            "ä¼˜å…ˆä½¿ç”¨å‡½æ•°ä¾èµ–ï¼ˆç®€å•åœºæ™¯ï¼‰"
        ]
    }


# ==================== æ ¹è·¯å¾„ ====================

@app.get("/")
async def root():
    return {
        "name": "ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ",
        "version": "2.0.0",
        "endpoints": {
            "anti_vs_pro": "/pattern/anti-vs-pro",
            "over_injection": "/pattern/over-injection",
            "testing": "/testing/demo",
            "performance": "/performance/cache",
            "organization": "/organization/demo",
            "error_handling": "/error-handling/demo",
            "summary": "/best-practices/summary"
        },
        "docs": "/docs"
    }


# ==================== è¿è¡Œè¯´æ˜ ====================
"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
åæ¨¡å¼è­¦ç¤º
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ æœåŠ¡å®šä½å™¨:
    éšå¼ä¾èµ–ï¼Œéš¾ä»¥æµ‹è¯•

âŒ è¿‡åº¦æ³¨å…¥:
    ä¾èµ–å¤ªå¤šï¼ŒèŒè´£æ··ä¹±

âŒ å¾ªç¯ä¾èµ–:
    A â†’ B â†’ Aï¼Œæ­»å¾ªç¯

âŒ å…¨å±€çŠ¶æ€:
    éš¾ä»¥æµ‹è¯•ï¼Œçº¿ç¨‹ä¸å®‰å…¨

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æœ€ä½³å®è·µ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… æ„é€ å‡½æ•°æ³¨å…¥:
    ä¾èµ–æ˜ç¡®ï¼Œæ˜“äºç†è§£

âœ… èŒè´£å•ä¸€:
    æ¯ä¸ªæœåŠ¡åªåšä¸€ä»¶äº‹

âœ… ä½¿ç”¨æ¥å£:
    ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“

âœ… ä¾èµ–ç¼“å­˜:
    é¿å…é‡å¤åˆ›å»º

âœ… yield èµ„æºç®¡ç†:
    è‡ªåŠ¨æ¸…ç†ï¼Œå¼‚å¸¸å®‰å…¨

âœ… æµ‹è¯•æ³¨å…¥ Mock:
    ä¸éœ€è¦çœŸå®èµ„æº

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ ¸å¿ƒåŸåˆ™
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ä¾èµ–å€’ç½®:
   é«˜å±‚ä¸ä¾èµ–ä½å±‚ï¼Œéƒ½ä¾èµ–æŠ½è±¡

2. å•ä¸€èŒè´£:
   æ¯ä¸ªæœåŠ¡åªåšä¸€ä»¶äº‹

3. æ˜¾å¼ä¾èµ–:
   çœ‹æ„é€ å‡½æ•°å°±çŸ¥é“éœ€è¦ä»€ä¹ˆ

4. æ˜“äºæµ‹è¯•:
   å¯ä»¥æ³¨å…¥ Mock

5. æ€§èƒ½ä¼˜åŒ–:
   åˆ©ç”¨ç¼“å­˜é¿å…é‡å¤åˆ›å»º

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
