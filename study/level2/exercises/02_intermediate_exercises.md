# Level 2 è¿›é˜¶ç»ƒä¹ é¢˜ï¼šæ·±å…¥ä¾èµ–æ³¨å…¥

## ğŸ¯ ç»ƒä¹ ç›®æ ‡

é€šè¿‡å¤æ‚åœºæ™¯çš„ç»ƒä¹ ï¼ŒæŒæ¡å‡½æ•°ä¾èµ– vs ç±»ä¾èµ–çš„é€‰æ‹©ã€ä¾èµ–ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€ä»¥åŠä½¿ç”¨ yield ç®¡ç†èµ„æºã€‚

---

## ç»ƒä¹  1: å‡½æ•°ä¾èµ– vs ç±»ä¾èµ– - ä½•æ—¶é€‰æ‹©å“ªä¸ªï¼Ÿ

### ğŸ¯ å­¦ä¹ ç›®æ ‡
ç†è§£å‡½æ•°ä¾èµ–å’Œç±»ä¾èµ–çš„åŒºåˆ«ï¼Œèƒ½å¤Ÿæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„ä¾èµ–å½¢å¼

### ğŸ’¡ è´¹æ›¼ç±»æ¯”ï¼šå·¥å…·é€‰æ‹©

```
å‡½æ•°ä¾èµ– = ç®€å•å·¥å…·ï¼ˆèºä¸åˆ€ï¼‰
- è½»ä¾¿ã€ç®€å•
- é€‚åˆç®€å•çš„ä»»åŠ¡
- æ²¡æœ‰è®°å¿†åŠŸèƒ½ï¼ˆæ— çŠ¶æ€ï¼‰

ç±»ä¾èµ– = å¤šåŠŸèƒ½å·¥å…·ï¼ˆç‘å£«å†›åˆ€ï¼‰
- åŠŸèƒ½ä¸°å¯Œã€å¯é…ç½®
- é€‚åˆå¤æ‚çš„ä»»åŠ¡
- æœ‰è®°å¿†åŠŸèƒ½ï¼ˆæœ‰çŠ¶æ€ï¼‰
```

### ğŸ“ ä»»åŠ¡

æ¯”è¾ƒä¸¤ç§ä¾èµ–å½¢å¼ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸‹é€‰æ‹©æœ€åˆé€‚çš„å®ç°ï¼š

```python
from fastapi import FastAPI, Depends, Header, HTTPException
from typing import Dict, Optional
from datetime import datetime, timedelta
import time

app = FastAPI()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 1: ç®€å•çš„é…ç½®è·å–ï¼ˆç”¨å‡½æ•°ä¾èµ–è¿˜æ˜¯ç±»ä¾èµ–ï¼Ÿï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# TODO: é€‰æ‹©åˆé€‚çš„ä¾èµ–å½¢å¼
# æ€è€ƒï¼šé…ç½®æ˜¯å›ºå®šçš„ï¼Œè¿˜æ˜¯éœ€è¦ç®¡ç†çŠ¶æ€çš„ï¼Ÿ
class AppConfig:
    """åº”ç”¨é…ç½®"""
    app_name: str = "My API"
    version: str = "1.0.0"
    debug: bool = True

# æ–¹æ¡ˆ A: å‡½æ•°ä¾èµ–
def get_config() -> AppConfig:
    """è·å–é…ç½®"""
    return AppConfig()

# æ–¹æ¡ˆ B: ç±»ä¾èµ–
class ConfigProvider:
    """é…ç½®æä¾›è€…"""
    def __init__(self):
        self._config = AppConfig()

    def __call__(self) -> AppConfig:
        return self._config

# TODO: ä½ è®¤ä¸ºåº”è¯¥ç”¨å“ªä¸ªæ–¹æ¡ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
# åœ¨ä¸‹é¢å®ç°ä½ çš„é€‰æ‹©
@app.get("/config")
async def get_app_config(
    # æ³¨å…¥ä½ çš„ä¾èµ–é€‰æ‹©
):
    pass

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 2: API é™æµå™¨ï¼ˆç”¨å‡½æ•°ä¾èµ–è¿˜æ˜¯ç±»ä¾èµ–ï¼Ÿï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# TODO: é€‰æ‹©åˆé€‚çš„ä¾èµ–å½¢å¼
# æ€è€ƒï¼šé™æµéœ€è¦è®°ä½æ¯ä¸ªè¯·æ±‚çš„æ¬¡æ•°å—ï¼Ÿ
class RateLimiter:
    """API é™æµå™¨"""
    def __init__(self, max_requests: int = 10, window: int = 60):
        """
        max_requests: æ—¶é—´çª—å£å†…æœ€å¤§è¯·æ±‚æ•°
        window: æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
        """
        self.max_requests = max_requests
        self.window = window
        self._requests: Dict[str, list] = {}  # {ip: [timestamp1, timestamp2, ...]}

    def check_rate_limit(self, identifier: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™æµ"""
        now = time.time()

        # è·å–æˆ–åˆ›å»ºè¯¥ identifier çš„è¯·æ±‚è®°å½•
        if identifier not in self._requests:
            self._requests[identifier] = []

        # æ¸…ç†è¿‡æœŸçš„è¯·æ±‚è®°å½•
        self._requests[identifier] = [
            ts for ts in self._requests[identifier]
            if now - ts < self.window
        ]

        # æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
        if len(self._requests[identifier]) >= self.max_requests:
            return False

        # è®°å½•æœ¬æ¬¡è¯·æ±‚
        self._requests[identifier].append(now)
        return True

# TODO: ä½ è®¤ä¸ºåº”è¯¥ç”¨å‡½æ•°è¿˜æ˜¯ç±»ä¾èµ–ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
# åœ¨ä¸‹é¢å®ç°ä½ çš„é€‰æ‹©
def check_rate_limit(
    # è®¾è®¡ä½ çš„ä¾èµ–
):
    pass

@app.get("/api/data")
async def get_data(
    # æ³¨å…¥ä½ çš„ä¾èµ–
):
    pass

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 3: å¸¦ç¼“å­˜çš„ç”¨æˆ·è®¤è¯ï¼ˆç”¨å‡½æ•°ä¾èµ–è¿˜æ˜¯ç±»ä¾èµ–ï¼Ÿï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class User:
    id: int
    username: str

# TODO: é€‰æ‹©åˆé€‚çš„ä¾èµ–å½¢å¼
# æ€è€ƒï¼šéœ€è¦ç¼“å­˜å·²éªŒè¯çš„ç”¨æˆ·å—ï¼Ÿéœ€è¦ç®¡ç†çŠ¶æ€å—ï¼Ÿ

# æ–¹æ¡ˆ A: å‡½æ•°ä¾èµ–
def get_current_user(token: str = Header(...)) -> User:
    """ä» token è·å–å½“å‰ç”¨æˆ·ï¼ˆæ— ç¼“å­˜ï¼‰"""
    # æ¯æ¬¡éƒ½é‡æ–°éªŒè¯ token
    payload = decode_token(token)  # æ¨¡æ‹Ÿè§£ç 
    user = fetch_user_from_db(payload["user_id"])  # æ¨¡æ‹ŸæŸ¥è¯¢æ•°æ®åº“
    return user

# æ–¹æ¡ˆ B: ç±»ä¾èµ–
class CachedAuth:
    """å¸¦ç¼“å­˜çš„è®¤è¯ï¼ˆæœ‰çŠ¶æ€ï¼‰"""
    def __init__(self, cache_ttl: int = 300):
        self.cache_ttl = cache_ttl
        self._cache: Dict[str, tuple] = {}  # {token: (user, timestamp)}

    def __call__(self, token: str = Header(...)) -> User:
        """ä» token è·å–å½“å‰ç”¨æˆ·ï¼ˆæœ‰ç¼“å­˜ï¼‰"""
        # TODO: å®ç°å¸¦ç¼“å­˜çš„è®¤è¯é€»è¾‘
        # 1. æ£€æŸ¥ç¼“å­˜
        # 2. å¦‚æœç¼“å­˜å‘½ä¸­ä¸”æœªè¿‡æœŸï¼Œè¿”å›ç¼“å­˜ç”¨æˆ·
        # 3. å¦åˆ™ï¼ŒéªŒè¯ token å¹¶æ›´æ–°ç¼“å­˜
        pass

# TODO: ä½ è®¤ä¸ºåº”è¯¥ç”¨å“ªä¸ªæ–¹æ¡ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
@app.get("/profile")
async def get_profile(
    # æ³¨å…¥ä½ çš„ä¾èµ–é€‰æ‹©
):
    pass
```

### âœ… å®Œæˆæ ‡å‡†

- [ ] ä¸ºæ¯ä¸ªåœºæ™¯é€‰æ‹©äº†åˆé€‚çš„ä¾èµ–å½¢å¼ï¼ˆå‡½æ•°æˆ–ç±»ï¼‰
- [ ] å®ç°äº†é€‰æ‹©æ–¹æ¡ˆçš„ä»£ç 
- [ ] èƒ½å¤Ÿè§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·é€‰æ‹©
- [ ] ç†è§£"æœ‰çŠ¶æ€"å’Œ"æ— çŠ¶æ€"çš„åŒºåˆ«

### ğŸ’¡ æç¤º

**å†³ç­–æ ‡å‡†**ï¼š

| éœ€æ±‚ | æ¨èæ–¹æ¡ˆ | åŸå›  |
|------|---------|------|
| ç®€å•è¿”å›å€¼ï¼Œæ— çŠ¶æ€ | å‡½æ•°ä¾èµ– | ç®€å•ã€è½»é‡ |
| éœ€è¦ç®¡ç†çŠ¶æ€ | ç±»ä¾èµ– | å¯ä»¥ç»´æŠ¤å®ä¾‹å˜é‡ |
| éœ€è¦å¤šä¸ªè¾…åŠ©æ–¹æ³• | ç±»ä¾èµ– | ä»£ç ç»„ç»‡æ›´æ¸…æ™° |
| éœ€è¦é…ç½®åˆå§‹åŒ– | ç±»ä¾èµ– | `__init__` å¯ä»¥æ¥æ”¶å‚æ•° |
| ä¸€æ¬¡æ€§è®¡ç®— | å‡½æ•°ä¾èµ– | æ— éœ€ç»´æŠ¤çŠ¶æ€ |

### ğŸ§ª éªŒè¯ç†è§£

ç»™ä½ ä¸€ä¸ªæ–°åœºæ™¯ï¼šå®ç°ä¸€ä¸ªè¯·æ±‚è®¡æ•°å™¨ï¼Œè®°å½•æ¯ä¸ª endpoint è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚ä½ åº”è¯¥ç”¨å‡½æ•°ä¾èµ–è¿˜æ˜¯ç±»ä¾èµ–ï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

**ç­”æ¡ˆï¼šç±»ä¾èµ–**

**åŸå› **ï¼š
1. éœ€è¦çŠ¶æ€ï¼šè®°ä½æ¯ä¸ª endpoint çš„è°ƒç”¨æ¬¡æ•°
2. éœ€è¦æŒä¹…åŒ–ï¼šè®¡æ•°éœ€è¦åœ¨å¤šä¸ªè¯·æ±‚é—´ç´¯ç§¯
3. å¯èƒ½æœ‰å¤šä¸ªæ–¹æ³•ï¼šè·å–è®¡æ•°ã€é‡ç½®è®¡æ•°ç­‰

```python
class EndpointCounter:
    """Endpoint è®¡æ•°å™¨"""
    def __init__(self):
        self._counts: Dict[str, int] = {}

    def __call__(self, endpoint_name: str) -> int:
        """è®¡æ•°å¹¶è¿”å›å½“å‰è®¡æ•°"""
        if endpoint_name not in self._counts:
            self._counts[endpoint_name] = 0
        self._counts[endpoint_name] += 1
        return self._counts[endpoint_name]

    def get_count(self, endpoint_name: str) -> int:
        """è·å–è®¡æ•°ï¼ˆä¸å¢åŠ ï¼‰"""
        return self._counts.get(endpoint_name, 0)

    def reset(self, endpoint_name: str):
        """é‡ç½®è®¡æ•°"""
        if endpoint_name in self._counts:
            del self._counts[endpoint_name]
```

**å¯¹æ¯”å‡½æ•°ä¾èµ–çš„é—®é¢˜**ï¼š
```python
# âŒ å‡½æ•°ä¾èµ–ï¼šéœ€è¦å…¨å±€å˜é‡ï¼ˆä¸å¥½ï¼‰
_counts = {}

def count_endpoint(endpoint_name: str) -> int:
    if endpoint_name not in _counts:
        _counts[endpoint_name] = 0
    _counts[endpoint_name] += 1
    return _counts[endpoint_name]

# é—®é¢˜ï¼š
# - å…¨å±€å˜é‡æ±¡æŸ“
# - æ— æ³•åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨
# - ä»£ç ç»„ç»‡ä¸æ¸…æ™°
```
</details>

---

## ç»ƒä¹  2: ä¾èµ–ç”Ÿå‘½å‘¨æœŸ - Request-scoped vs Application-scoped

### ğŸ¯ å­¦ä¹ ç›®æ ‡
ç†è§£ä¾èµ–çš„ç”Ÿå‘½å‘¨æœŸï¼ŒçŸ¥é“ä½•æ—¶ä½¿ç”¨è¯·æ±‚èŒƒå›´æˆ–åº”ç”¨èŒƒå›´

### ğŸ’¡ è´¹æ›¼ç±»æ¯”ï¼šé¤å…æœåŠ¡

```
Request-scopedï¼ˆè¯·æ±‚èŒƒå›´ï¼‰ï¼š
å°±åƒä¸€æ¬¡æ€§é¤å…·
- æ¯ä¸ªå®¢äººï¼ˆè¯·æ±‚ï¼‰ç”¨æ–°çš„
- ç”¨å®Œå°±æ‰”ï¼ˆé”€æ¯ï¼‰
- ä¸åŒå®¢äººä¸æ··ç”¨
- é€‚åˆï¼šæ•°æ®åº“è¿æ¥ã€ä¸´æ—¶æ–‡ä»¶

Application-scopedï¼ˆåº”ç”¨èŒƒå›´ï¼‰ï¼š
å°±åƒé¤å…çš„é¤æ¡Œ
- æ‰€æœ‰å®¢äººå…±äº«åŒä¸€å¼ æ¡Œå­
- ä¸€ç›´åœ¨é‚£é‡Œï¼ˆä¸é”€æ¯ï¼‰
- çŠ¶æ€æŒç»­ç´¯ç§¯
- é€‚åˆï¼šç¼“å­˜ã€é…ç½®ã€è¿æ¥æ± 
```

### ğŸ“ ä»»åŠ¡

è¯†åˆ«å“ªäº›èµ„æºåº”è¯¥ç”¨ Request-scopedï¼Œå“ªäº›åº”è¯¥ç”¨ Application-scopedï¼š

```python
from fastapi import FastAPI, Depends
from typing import Dict

app = FastAPI()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åˆ¤æ–­ä»¥ä¸‹èµ„æºåº”è¯¥ç”¨ä»€ä¹ˆç”Ÿå‘½å‘¨æœŸï¼Ÿ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# èµ„æº 1: æ•°æ®åº“è¿æ¥æ± 
class DatabasePool:
    """æ•°æ®åº“è¿æ¥æ± """
    def __init__(self):
        self._connections = []

    def get_connection(self):
        # ä»æ± ä¸­è·å–è¿æ¥
        pass

    def return_connection(self, conn):
        # å½’è¿˜è¿æ¥åˆ°æ± 
        pass

# TODO: è¿™ä¸ªèµ„æºåº”è¯¥ç”¨ä»€ä¹ˆç”Ÿå‘½å‘¨æœŸï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
# å®ç°ä½ çš„é€‰æ‹©

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# èµ„æº 2: è¯·æ±‚æ—¥å¿—è®°å½•å™¨
class RequestLogger:
    """è¯·æ±‚æ—¥å¿—è®°å½•å™¨"""
    def __init__(self):
        self.logs = []

    def log(self, message: str):
        self.logs.append({
            "message": message,
            "timestamp": datetime.now().isoformat()
        })

# TODO: è¿™ä¸ªèµ„æºåº”è¯¥ç”¨ä»€ä¹ˆç”Ÿå‘½å‘¨æœŸï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
# å®ç°ä½ çš„é€‰æ‹©

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# èµ„æº 3: å…¨å±€é…ç½®ç¼“å­˜
class ConfigCache:
    """é…ç½®ç¼“å­˜"""
    def __init__(self):
        self._cache: Dict[str, any] = {}

    def get(self, key: str, default=None):
        return self._cache.get(key, default)

    def set(self, key: str, value: any):
        self._cache[key] = value

# TODO: è¿™ä¸ªèµ„æºåº”è¯¥ç”¨ä»€ä¹ˆç”Ÿå‘½å‘¨æœŸï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
# å®ç°ä½ çš„é€‰æ‹©

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# èµ„æº 4: æ•°æ®åº“äº‹åŠ¡
class DatabaseTransaction:
    """æ•°æ®åº“äº‹åŠ¡"""
    def __init__(self, db_connection):
        self.db = db_connection
        self.db.begin()

    def commit(self):
        self.db.commit()

    def rollback(self):
        self.db.rollback()

# TODO: è¿™ä¸ªèµ„æºåº”è¯¥ç”¨ä»€ä¹ˆç”Ÿå‘½å‘¨æœŸï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
# å®ç°ä½ çš„é€‰æ‹©
```

### âœ… å®Œæˆæ ‡å‡†

- [ ] ä¸ºæ¯ä¸ªèµ„æºé€‰æ‹©äº†æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸ
- [ ] å®ç°äº†ä¾èµ–å‡½æ•°
- [ ] èƒ½å¤Ÿè§£é‡Šé€‰æ‹©çš„ç†ç”±
- [ ] ç†è§£ä¸¤ç§ç”Ÿå‘½å‘¨æœŸçš„åˆ›å»ºå’Œé”€æ¯æ—¶æœº

### ğŸ’¡ æç¤º

**åˆ¤æ–­æ ‡å‡†**ï¼š

| èµ„æºç±»å‹ | æ¨èç”Ÿå‘½å‘¨æœŸ | åŸå›  |
|---------|------------|------|
| æ•°æ®åº“è¿æ¥ï¼ˆå•ä¸ªï¼‰ | Request-scoped | æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹è¿æ¥ï¼Œç”¨å®Œå…³é—­ |
| æ•°æ®åº“è¿æ¥æ±  | Application-scoped | è¿æ¥æ± è®¾è®¡æ¥å…±äº« |
| æ•°æ®åº“äº‹åŠ¡ | Request-scoped | æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹äº‹åŠ¡ï¼Œç»“æŸæäº¤/å›æ»š |
| æœ¬åœ°ç¼“å­˜ï¼ˆå†…å­˜ï¼‰ | Application-scoped | å…¨å±€å…±äº«æé«˜æ€§èƒ½ |
| Redis è¿æ¥ | Application-scoped | è¿æ¥æ± è®¾è®¡æ¥å…±äº« |
| é…ç½®å¯¹è±¡ | Application-scoped | é…ç½®ä¸å˜ï¼Œå…¨å±€å…±äº« |
| Logger | Application-scoped | å…¨å±€å…±äº«æ—¥å¿—å®ä¾‹ |
| è¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯ | Request-scoped | æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ |
| ä¸´æ—¶æ–‡ä»¶ | Request-scoped | ç”¨å®Œåˆ é™¤ |

### ğŸ§ª éªŒè¯ç†è§£

å‡è®¾ä½ æœ‰ä¸€ä¸ª"ç”¨æˆ·ä¼šè¯"å¯¹è±¡ï¼Œå­˜å‚¨ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼ˆå¦‚è´­ç‰©è½¦å†…å®¹ï¼‰ã€‚åº”è¯¥ç”¨ä»€ä¹ˆç”Ÿå‘½å‘¨æœŸï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

**ç­”æ¡ˆï¼šRequest-scoped**ï¼ˆé€šå¸¸å­˜å‚¨åœ¨ Cookie æˆ– Session ä¸­ï¼‰

**åŸå› åˆ†æ**ï¼š

**è¯¯è§£**: å¯èƒ½ä¼šé€‰ Application-scopedï¼Œå› ä¸º"è´­ç‰©è½¦éœ€è¦åœ¨å¤šä¸ªè¯·æ±‚é—´ä¿æŒ"

**æ­£ç¡®ç†è§£**:
- ç”¨æˆ·ä¼šè¯æ•°æ®åº”è¯¥å­˜åœ¨å¤–éƒ¨å­˜å‚¨ï¼ˆRedisã€æ•°æ®åº“ã€Cookieï¼‰
- Request-scoped çš„ä¾èµ–è´Ÿè´£ï¼šä»å¤–éƒ¨å­˜å‚¨è¯»å– â†’ æ³¨å…¥åˆ°è¯·æ±‚ â†’ è¯·æ±‚ç»“æŸä¿å­˜
- ä¸æ˜¯æŠŠä¼šè¯æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆé‚£ä¼šå¯¼è‡´å¤šç”¨æˆ·æ•°æ®æ··ä¹±ï¼‰

**é”™è¯¯ç¤ºèŒƒ**ï¼ˆApplication-scopedï¼‰ï¼š
```python
# âŒ é”™è¯¯ï¼šæ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ªè´­ç‰©è½¦ï¼
cart = ShoppingCart()

@app.post("/cart/add")
async def add_to_cart(item: str):
    cart.add(item)  # ç”¨æˆ· A æ·»åŠ å•†å“
    # ç”¨æˆ· B ä¹Ÿä¼šçœ‹åˆ°ç”¨æˆ· A çš„å•†å“ï¼

# é—®é¢˜ï¼š
# - æ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ªè´­ç‰©è½¦å¯¹è±¡
# - ç”¨æˆ· A å’Œ B çš„æ•°æ®æ··åœ¨ä¸€èµ·
```

**æ­£ç¡®åšæ³•**ï¼ˆRequest-scoped + å¤–éƒ¨å­˜å‚¨ï¼‰ï¼š
```python
# âœ… æ­£ç¡®ï¼šæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çš„ä¼šè¯å¯¹è±¡

def get_user_session(
    session_id: str = Cookie(...)
) -> UserSession:
    """
    Request-scoped:
    1. ä» Redis è¯»å–è¯¥ç”¨æˆ·çš„ä¼šè¯æ•°æ®
    2. æ³¨å…¥åˆ°è¯·æ±‚
    3. è¯·æ±‚ç»“æŸæ—¶ä¿å­˜å› Redis
    """
    session_data = redis.get(f"session:{session_id}")
    return UserSession.parse_raw(session_data)

@app.post("/cart/add")
async def add_to_cart(
    item: str,
    session: UserSession = Depends(get_user_session)  # æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹
):
    session.cart.add(item)
    # session ä¼šè‡ªåŠ¨ä¿å­˜å› Redisï¼ˆä½¿ç”¨ yieldï¼‰
```

**å…³é”®åŒºåˆ«**ï¼š
- Application-scopedï¼šå†…å­˜ä¸­å…¨å±€å…±äº«ï¼ˆé€‚åˆé…ç½®ã€ç¼“å­˜ï¼‰
- Request-scopedï¼šæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ï¼Œä½†å¯ä»¥ä»å¤–éƒ¨å­˜å‚¨è¯»å–ï¼ˆé€‚åˆä¼šè¯ï¼‰
</details>

---

## ç»ƒä¹  3: ä½¿ç”¨ yield ç®¡ç†èµ„æº

### ğŸ¯ å­¦ä¹ ç›®æ ‡
æŒæ¡ä½¿ç”¨ `yield` å…³é”®å­—ç®¡ç†èµ„æºçš„åˆ›å»ºå’Œæ¸…ç†

### ğŸ’¡ è´¹æ›¼ç±»æ¯”ï¼šå€Ÿç”¨å™¨æ

```
æ²¡æœ‰ yieldï¼ˆå¿˜è®°å½’è¿˜ï¼‰ï¼š
ä½ ï¼ˆendpointï¼‰å‘å™¨æå®¤ï¼ˆä¾èµ–ï¼‰å€Ÿäº†ç¯®çƒ
ç©å®Œåç›´æ¥å›å®¶
å™¨æå®¤ï¼ˆèµ„æºï¼‰æ°¸è¿œå°‘äº†ä¸€ä¸ªç¯®çƒ
â†’ èµ„æºæ³„æ¼ï¼

æœ‰ yieldï¼ˆè‡ªåŠ¨å½’è¿˜ï¼‰ï¼š
ä½ ï¼ˆendpointï¼‰å€Ÿäº†ç¯®çƒ
ç©å®Œåå¿…é¡»å½’è¿˜
å™¨æå®¤ç®¡ç†å‘˜ï¼ˆyieldï¼‰è‡ªåŠ¨æ”¶å›
â†’ èµ„æºæ­£ç¡®ç®¡ç†ï¼
```

### ğŸ“ ä»»åŠ¡

å®ç°ä½¿ç”¨ `yield` ç®¡ç†èµ„æºçš„ä¾èµ–ï¼š

```python
from fastapi import FastAPI, Depends
import tempfile
import os

app = FastAPI()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä»»åŠ¡ 1: ä½¿ç”¨ yield ç®¡ç†æ•°æ®åº“è¿æ¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class Database:
    """æ¨¡æ‹Ÿæ•°æ®åº“"""
    def __init__(self):
        self.connected = False

    def connect(self):
        self.connected = True
        print("âœ… æ•°æ®åº“å·²è¿æ¥")

    def close(self):
        self.connected = False
        print("âŒ æ•°æ®åº“å·²å…³é—­")

    def query(self, sql: str):
        if not self.connected:
            raise Exception("æ•°æ®åº“æœªè¿æ¥")
        return f"æ‰§è¡ŒæŸ¥è¯¢: {sql}"

# TODO: å®ç° get_db ä¾èµ–ï¼Œä½¿ç”¨ yield ç®¡ç†è¿æ¥
def get_db():
    """
    ä½¿ç”¨ yield ç®¡ç†æ•°æ®åº“è¿æ¥ï¼š
    1. åˆ›å»ºè¿æ¥
    2. yield dbï¼ˆäº¤ç»™ endpoint ä½¿ç”¨ï¼‰
    3. å…³é—­è¿æ¥ï¼ˆåœ¨ finally ä¸­ï¼‰
    """
    # TODO: å®ç°è¿™ä¸ªå‡½æ•°
    pass

@app.get("/users")
async def list_users(db: Database = Depends(get_db)):
    """ä½¿ç”¨æ•°æ®åº“"""
    return db.query("SELECT * FROM users")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä»»åŠ¡ 2: ä½¿ç”¨ yield ç®¡ç†æ•°æ®åº“äº‹åŠ¡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class Transaction:
    """æ•°æ®åº“äº‹åŠ¡"""
    def __init__(self, db: Database):
        self.db = db
        self.committed = False
        self.rolled_back = False

    def begin(self):
        print("ğŸ“ å¼€å§‹äº‹åŠ¡")
        self.db.connected = True

    def commit(self):
        print("âœ… æäº¤äº‹åŠ¡")
        self.committed = True

    def rollback(self):
        print("âŒ å›æ»šäº‹åŠ¡")
        self.rolled_back = True

# TODO: å®ç° get_transaction ä¾èµ–ï¼Œè‡ªåŠ¨ç®¡ç†äº‹åŠ¡
# è¦æ±‚ï¼š
# 1. å¼€å§‹äº‹åŠ¡
# 2. yield transaction
# 3. å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæäº¤äº‹åŠ¡
# 4. å¦‚æœæœ‰å¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡
def get_transaction():
    """
    ä½¿ç”¨ yield + try/except/finally ç®¡ç†äº‹åŠ¡
    """
    # TODO: å®ç°è¿™ä¸ªå‡½æ•°
    pass

@app.post("/users")
async def create_user(
    username: str,
    txn: Transaction = Depends(get_transaction)
):
    """åˆ›å»ºç”¨æˆ·ï¼ˆè‡ªåŠ¨æäº¤/å›æ»šäº‹åŠ¡ï¼‰"""
    # è¿™é‡Œæ‰§è¡Œæ•°æ®åº“æ“ä½œ
    print(f"åˆ›å»ºç”¨æˆ·: {username}")
    # å¦‚æœè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
    return {"username": username}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä»»åŠ¡ 3: ä½¿ç”¨ yield ç®¡ç†ä¸´æ—¶æ–‡ä»¶
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TempFile:
    """ä¸´æ—¶æ–‡ä»¶"""
    def __init__(self, filename: str):
        self.filename = filename
        self.file = None

    def write(self, content: str):
        if self.file:
            self.file.write(content)

    def read(self) -> str:
        if self.file:
            self.file.seek(0)
            return self.file.read()
        return ""

# TODO: å®ç° get_temp_file ä¾èµ–ï¼Œè‡ªåŠ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶
def get_temp_file():
    """
    ä½¿ç”¨ yield ç®¡ç†ä¸´æ—¶æ–‡ä»¶ï¼š
    1. åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    2. yield temp_file
    3. åœ¨ finally ä¸­å…³é—­å¹¶åˆ é™¤æ–‡ä»¶
    """
    # TODO: å®ç°è¿™ä¸ªå‡½æ•°
    # æç¤ºï¼šä½¿ç”¨ tempfile.NamedTemporaryFile
    pass

@app.post("/process")
async def process_data(
    data: str,
    temp_file: TempFile = Depends(get_temp_file)
):
    """å¤„ç†æ•°æ®å¹¶å†™å…¥ä¸´æ—¶æ–‡ä»¶"""
    temp_file.write(data)
    processed = temp_file.read().upper()
    return {"processed": processed}

# æ³¨æ„ï¼šè¯·æ±‚ç»“æŸåï¼Œä¸´æ—¶æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤
```

### âœ… å®Œæˆæ ‡å‡†

- [ ] å®ç° `get_db` ä¾èµ–ï¼Œæ­£ç¡®ç®¡ç†æ•°æ®åº“è¿æ¥
- [ ] å®ç° `get_transaction` ä¾èµ–ï¼Œè‡ªåŠ¨æäº¤/å›æ»š
- [ ] å®ç° `get_temp_file` ä¾èµ–ï¼Œè‡ªåŠ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶
- [ ] ç†è§£ `yield` å‰åçš„ä»£ç æ‰§è¡Œæ—¶æœº

### ğŸ’¡ æç¤º

**yield çš„æ‰§è¡Œæµç¨‹**ï¼š
```python
def get_resource():
    # æ­¥éª¤ 1: è¯·æ±‚å¼€å§‹æ—¶æ‰§è¡Œ
    resource = create_resource()

    try:
        yield resource  # â† æš‚åœï¼Œäº¤ç»™ endpoint

    finally:
        # æ­¥éª¤ 2: è¯·æ±‚ç»“æŸæ—¶æ‰§è¡Œ
        cleanup_resource(resource)
```

**å¼‚å¸¸å¤„ç†**ï¼š
```python
def get_transaction():
    txn = Transaction()
    txn.begin()

    try:
        yield txn

    except Exception:
        # å¦‚æœ endpoint æŠ›å‡ºå¼‚å¸¸
        txn.rollback()
        raise  # é‡æ–°æŠ›å‡ºå¼‚å¸¸

    else:
        # å¦‚æœ endpoint æ­£å¸¸æ‰§è¡Œ
        txn.commit()

    finally:
        # æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½ä¼šæ‰§è¡Œ
        cleanup()
```

### ğŸ§ª éªŒè¯ç†è§£

ä¸ºä»€ä¹ˆä½¿ç”¨ `yield` åï¼Œèµ„æºä¼šåœ¨è¯·æ±‚ç»“æŸæ—¶è‡ªåŠ¨æ¸…ç†ï¼ŸFastAPI æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

**FastAPI çš„ yield å®ç°åŸç†**ï¼š

```python
# FastAPI å†…éƒ¨ç±»ä¼¼è¿™æ ·çš„å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

async def handle_request(endpoint):
    # 1. è°ƒç”¨ä¾èµ–å‡½æ•°
    dependency_gen = get_dependency()  # è¿”å›ç”Ÿæˆå™¨

    # 2. è·å– yield å‰çš„å€¼
    try:
        resource = next(dependency_gen)
    except StopIteration:
        resource = None

    # 3. è°ƒç”¨ endpoint
    try:
        result = await endpoint(resource)
        return result
    except Exception as e:
        # 4. endpoint æŠ›å‡ºå¼‚å¸¸
        # ç»§ç»­æ‰§è¡Œç”Ÿæˆå™¨ï¼ˆè¿›å…¥ finallyï¼‰
        try:
            dependency_gen.throw(e)
        except:
            pass
        raise
    finally:
        # 5. è¯·æ±‚ç»“æŸï¼Œç»§ç»­ç”Ÿæˆå™¨
        try:
            dependency_gen.close()  # è§¦å‘ finally
        except:
            pass
```

**å…³é”®ç‚¹**ï¼š
1. Python ç”Ÿæˆå™¨çš„ `yield` ä¼šæš‚åœå‡½æ•°æ‰§è¡Œ
2. è°ƒç”¨ `next(gen)` ä¼šæ‰§è¡Œåˆ° `yield` å¹¶æš‚åœ
3. è°ƒç”¨ `gen.close()` æˆ– `gen.throw()` ä¼šä» `yield` åç»§ç»­æ‰§è¡Œ
4. `finally` å—æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œ

**å®é™…ä¾‹å­**ï¼š
```python
def test():
    print("1. å¼€å§‹")
    try:
        yield "èµ„æº"
        print("3. endpoint æ­£å¸¸è¿”å›")
    finally:
        print("4. æ¸…ç†èµ„æº")

gen = test()
print("2. è·å–èµ„æº:", next(gen))
print("ç»§ç»­æ‰§è¡Œ...")
gen.close()  # è§¦å‘ finally

# è¾“å‡ºï¼š
# 1. å¼€å§‹
# 2. è·å–èµ„æº: èµ„æº
# 4. æ¸…ç†èµ„æº
```
</details>

---

## ç»ƒä¹  4: ç»¼åˆç»ƒä¹  - å®ç°ä¸€ä¸ªå¸¦ç¼“å­˜å’Œé™æµçš„ API

### ğŸ¯ å­¦ä¹ ç›®æ ‡
å°†ç±»ä¾èµ–ã€ç”Ÿå‘½å‘¨æœŸã€yield ç®¡ç†æ•´åˆåˆ°ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿä¸­

### ğŸ’¡ è´¹æ›¼ç±»æ¯”ï¼šæ™ºèƒ½å›¾ä¹¦é¦†

```
è¿™ä¸ªç»ƒä¹ å°±åƒè®¾è®¡ä¸€ä¸ªæ™ºèƒ½å›¾ä¹¦é¦†ç³»ç»Ÿï¼š

1. Application-scoped: ç¼“å­˜ç³»ç»Ÿï¼ˆæ‰€æœ‰è¯»è€…å…±äº«ï¼‰
2. Application-scoped: é™æµå™¨ï¼ˆé˜²æ­¢æœ‰äººé¢‘ç¹å€Ÿä¹¦ï¼‰
3. Request-scoped: å€Ÿé˜…è®°å½•ï¼ˆæ¯æ¬¡å€Ÿé˜…ç‹¬ç«‹è®°å½•ï¼‰
4. yield ç®¡ç†: è‡ªåŠ¨å½’è¿˜è¶…æ—¶çš„ä¹¦
```

### ğŸ“ ä»»åŠ¡

å®ç°ä¸€ä¸ªæ–‡ç«  APIï¼ŒåŒ…å«ç¼“å­˜ã€é™æµã€æ—¥å¿—è®°å½•ï¼š

```python
from fastapi import FastAPI, Depends, HTTPException, Header
from pydantic import BaseModel
from typing import Dict, Optional
from datetime import datetime, timedelta
import time
import hashlib

app = FastAPI()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æ•°æ®æ¨¡å‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class Article(BaseModel):
    id: int
    title: str
    content: str
    author: str

class ArticleCache(BaseModel):
    article: Article
    cached_at: datetime

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. Application-scoped: æ–‡ç« ç¼“å­˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class ArticleCacheService:
    """æ–‡ç« ç¼“å­˜æœåŠ¡ï¼ˆApplication-scopedï¼‰"""

    def __init__(self, ttl: int = 300):
        """
        ttl: ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
        """
        self.ttl = ttl
        self._cache: Dict[int, ArticleCache] = {}

    def get(self, article_id: int) -> Optional[Article]:
        """
        ä»ç¼“å­˜è·å–æ–‡ç« 
        å¦‚æœç¼“å­˜è¿‡æœŸï¼Œè¿”å› None
        """
        # TODO: å®ç°ç¼“å­˜è·å–é€»è¾‘
        # 1. æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨
        # 2. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        # 3. è¿”å›æ–‡ç« æˆ– None
        pass

    def set(self, article: Article):
        """å°†æ–‡ç« å­˜å…¥ç¼“å­˜"""
        # TODO: å®ç°ç¼“å­˜å­˜å‚¨é€»è¾‘
        pass

    def clear(self):
        """æ¸…ç©ºæ‰€æœ‰ç¼“å­˜"""
        self._cache.clear()

# TODO: åˆ›å»ºå…¨å±€ç¼“å­˜å®ä¾‹ï¼ˆApplication-scopedï¼‰
# æç¤ºï¼šç›´æ¥åˆ›å»ºï¼Œä¸è¦ç”¨ Depends

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. Application-scoped: API é™æµå™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class RateLimiter:
    """API é™æµå™¨ï¼ˆApplication-scopedï¼‰"""

    def __init__(self, max_requests: int = 10, window: int = 60):
        self.max_requests = max_requests
        self.window = window
        self._requests: Dict[str, list] = {}

    def is_allowed(self, identifier: str) -> bool:
        """
        æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚
        è¿”å› True è¡¨ç¤ºå…è®¸ï¼ŒFalse è¡¨ç¤ºè¶…è¿‡é™æµ
        """
        # TODO: å®ç°é™æµé€»è¾‘
        # 1. æ¸…ç†è¿‡æœŸè®°å½•
        # 2. æ£€æŸ¥è¯·æ±‚æ•°é‡
        # 3. è®°å½•æœ¬æ¬¡è¯·æ±‚
        # 4. è¿”å›æ˜¯å¦å…è®¸
        pass

# TODO: åˆ›å»ºå…¨å±€é™æµå™¨å®ä¾‹ï¼ˆApplication-scopedï¼‰

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. Request-scoped: è¯·æ±‚æ—¥å¿—è®°å½•å™¨ï¼ˆä½¿ç”¨ yieldï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class RequestLogger:
    """è¯·æ±‚æ—¥å¿—è®°å½•å™¨ï¼ˆRequest-scopedï¼‰"""

    def __init__(self):
        self.start_time = time.time()
        self.actions = []

    def log(self, action: str):
        """è®°å½•ä¸€ä¸ªæ“ä½œ"""
        self.actions.append({
            "action": action,
            "time": datetime.now().isoformat()
        })

    def get_summary(self) -> dict:
        """è·å–æ—¥å¿—æ‘˜è¦"""
        return {
            "duration": time.time() - self.start_time,
            "actions": self.actions
        }

# TODO: å®ç° get_request_logger ä¾èµ–ï¼ˆRequest-scoped + yieldï¼‰
# è¦æ±‚ï¼š
# 1. åˆ›å»º RequestLogger
# 2. è®°å½•è¯·æ±‚å¼€å§‹
# 3. yield logger
# 4. åœ¨ finally ä¸­è®°å½•è¯·æ±‚ç»“æŸ
def get_request_logger():
    pass

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. æ¨¡æ‹Ÿæ•°æ®åº“
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class ArticleDatabase:
    """æ¨¡æ‹Ÿæ•°æ®åº“"""
    def __init__(self):
        self.articles = {
            1: Article(id=1, title="FastAPI å…¥é—¨", content="...", author="Alice"),
            2: Article(id=2, title="Python å¼‚æ­¥ç¼–ç¨‹", content="...", author="Bob"),
            3: Article(id=3, title="ä¾èµ–æ³¨å…¥è¯¦è§£", content="...", author="Charlie"),
        }

    def get_by_id(self, article_id: int) -> Optional[Article]:
        """æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢ï¼ˆæ…¢æ“ä½œï¼‰"""
        time.sleep(0.1)  # æ¨¡æ‹ŸæŸ¥è¯¢å»¶è¿Ÿ
        return self.articles.get(article_id)

# TODO: åˆ›å»ºå…¨å±€æ•°æ®åº“å®ä¾‹ï¼ˆApplication-scopedï¼‰

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. ä¾èµ–æ³¨å…¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# TODO: å®ç° get_cache ä¾èµ–ï¼ˆè¿”å›å…¨å±€ç¼“å­˜ï¼‰
def get_cache() -> ArticleCacheService:
    pass

# TODO: å®ç° get_rate_limiter ä¾èµ–ï¼ˆè¿”å›å…¨å±€é™æµå™¨ï¼‰
def get_rate_limiter() -> RateLimiter:
    pass

# TODO: å®ç° check_rate_limit ä¾èµ–ï¼ˆæ£€æŸ¥é™æµï¼Œè¶…è¿‡åˆ™æŠ›å¼‚å¸¸ï¼‰
def check_rate_limit(
    x_forwarded_for: Optional[str] = Header(None),
    limiter: RateLimiter = Depends(get_rate_limiter)
):
    """
    æ£€æŸ¥è¯·æ±‚æ˜¯å¦è¶…è¿‡é™æµ
    å¦‚æœè¶…è¿‡ï¼ŒæŠ›å‡º HTTPException(429)
    """
    # TODO: è·å–å®¢æˆ·ç«¯ IP
    # TODO: æ£€æŸ¥é™æµ
    # TODO: å¦‚æœè¶…è¿‡é™åˆ¶ï¼ŒæŠ›å‡ºå¼‚å¸¸
    pass

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. Endpoints
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@app.get("/articles/{article_id}")
async def get_article(
    article_id: int,
    cache: ArticleCacheService = Depends(get_cache),
    db: ArticleDatabase = Depends(lambda: db),  # å…¨å±€æ•°æ®åº“
    logger: RequestLogger = Depends(get_request_logger),
    # TODO: æ³¨å…¥é™æµæ£€æŸ¥
):
    """
    è·å–æ–‡ç« 

    æµç¨‹ï¼š
    1. æ£€æŸ¥é™æµï¼ˆè‡ªåŠ¨ï¼‰
    2. è®°å½•è¯·æ±‚å¼€å§‹
    3. å°è¯•ä»ç¼“å­˜è·å–
    4. å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è·å–
    5. æ›´æ–°ç¼“å­˜
    6. è®°å½•è¯·æ±‚ç»“æŸ
    7. è¿”å›æ–‡ç«  + æ—¥å¿—æ‘˜è¦
    """
    logger.log(f"è¯·æ±‚æ–‡ç«  {article_id}")

    # TODO: å®ç°ç¼“å­˜é€»è¾‘
    # 1. å°è¯•ä»ç¼“å­˜è·å–
    # 2. å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œè®°å½•æ—¥å¿—å¹¶è¿”å›
    # 3. å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è·å–
    # 4. æ›´æ–°ç¼“å­˜
    # 5. è®°å½•æ—¥å¿—

    # è¿”å›ç»“æœ
    return {
        "article": article,
        "cache_status": "hit" if cached else "miss",
        "log": logger.get_summary()
    }

@app.post("/cache/clear")
async def clear_cache(
    cache: ArticleCacheService = Depends(get_cache)
):
    """æ¸…ç©ºç¼“å­˜ï¼ˆç®¡ç†æ¥å£ï¼‰"""
    cache.clear()
    return {"message": "ç¼“å­˜å·²æ¸…ç©º"}
```

### âœ… å®Œæˆæ ‡å‡†

- [ ] å®ç° ArticleCacheServiceï¼ˆå¸¦ TTL çš„ç¼“å­˜ï¼‰
- [ ] å®ç° RateLimiterï¼ˆæ»‘åŠ¨çª—å£é™æµï¼‰
- [ ] å®ç° RequestLoggerï¼ˆä½¿ç”¨ yield ç®¡ç†æ—¥å¿—ï¼‰
- [ ] å®ç° `get_article` endpointï¼ˆç¼“å­˜ + æ•°æ®åº“ + æ—¥å¿—ï¼‰
- [ ] å®ç°é™æµæ£€æŸ¥ï¼ˆè¶…è¿‡é™åˆ¶è¿”å› 429ï¼‰
- [ ] ç†è§£ä¸‰ç§ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ–¹å¼

### ğŸ’¡ æç¤º

**ä¸‰ç§ç”Ÿå‘½å‘¨æœŸå¯¹æ¯”**ï¼š

| ç»„ä»¶ | ç”Ÿå‘½å‘¨æœŸ | ç®¡ç†æ–¹å¼ | åŸå›  |
|------|---------|---------|------|
| Cache | Application | å…¨å±€å®ä¾‹ | æ‰€æœ‰è¯·æ±‚å…±äº«ç¼“å­˜ |
| RateLimiter | Application | å…¨å±€å®ä¾‹ | éœ€è¦è·¨è¯·æ±‚ç´¯ç§¯è®¡æ•° |
| Database | Application | å…¨å±€å®ä¾‹ | æ¨¡æ‹Ÿè¿æ¥æ±  |
| Logger | Request | yield | æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çš„æ—¥å¿—è®°å½• |

**æ‰§è¡Œæµç¨‹**ï¼š
```
1. è¯·æ±‚åˆ°è¾¾
2. check_rate_limit æ£€æŸ¥é™æµï¼ˆApplication-scopedï¼‰
3. get_request_logger åˆ›å»ºæ—¥å¿—ï¼ˆRequest-scopedï¼‰
4. get_article å°è¯•ç¼“å­˜ï¼ˆApplication-scopedï¼‰
5. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼ˆApplication-scopedï¼‰
6. æ›´æ–°ç¼“å­˜
7. è¿”å›å“åº”
8. è¯·æ±‚ç»“æŸï¼Œlogger çš„ finally æ‰§è¡Œ
```

### ğŸ§ª éªŒè¯ç†è§£

ä¸ºä»€ä¹ˆç¼“å­˜å’Œé™æµå™¨æ˜¯ Application-scopedï¼Œè€Œæ—¥å¿—è®°å½•å™¨æ˜¯ Request-scopedï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

**ç¼“å­˜ï¼ˆApplication-scopedï¼‰**ï¼š
- ç›®çš„ï¼šæé«˜æ€§èƒ½ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- éœ€è¦ï¼šå¤šä¸ªè¯·æ±‚å…±äº«ç¼“å­˜æ•°æ®
- å¦‚æœæ˜¯ Request-scopedï¼šæ¯ä¸ªè¯·æ±‚éƒ½é‡æ–°å¼€å§‹ç¼“å­˜ï¼Œæ²¡æœ‰æ„ä¹‰

**é™æµå™¨ï¼ˆApplication-scopedï¼‰**ï¼š
- ç›®çš„ï¼šé˜²æ­¢æŸä¸ªç”¨æˆ·é¢‘ç¹è¯·æ±‚
- éœ€è¦ï¼šè·¨è¯·æ±‚ç´¯ç§¯è®¡æ•°
- å¦‚æœæ˜¯ Request-scopedï¼šæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯æ–°çš„è®¡æ•°ï¼Œæ— æ³•é™æµ

**æ—¥å¿—è®°å½•å™¨ï¼ˆRequest-scopedï¼‰**ï¼š
- ç›®çš„ï¼šè®°å½•å•ä¸ªè¯·æ±‚çš„æ“ä½œ
- éœ€è¦ï¼šæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çš„æ—¥å¿—
- å¦‚æœæ˜¯ Application-scopedï¼šæ‰€æœ‰è¯·æ±‚çš„æ—¥å¿—æ··åœ¨ä¸€èµ·

**ç±»æ¯”**ï¼š
- ç¼“å­˜ = å…¬å‘Šæ ï¼ˆæ‰€æœ‰äººçœ‹åŒä¸€ä¸ªï¼‰
- é™æµå™¨ = é—¨ç¦ç³»ç»Ÿï¼ˆè®°å½•æ‰€æœ‰è¿›å‡ºï¼‰
- æ—¥å¿— = ä¸ªäººæ—¥è®°ï¼ˆæ¯äººæœ‰è‡ªå·±çš„ï¼‰
</details>

---

## âœ… æ€»ç»“æ£€æŸ¥æ¸…å•

å®Œæˆæ‰€æœ‰ç»ƒä¹ åï¼Œæ£€æŸ¥ä½ æ˜¯å¦èƒ½å¤Ÿï¼š

- [ ] æ ¹æ®åœºæ™¯é€‰æ‹©å‡½æ•°ä¾èµ–æˆ–ç±»ä¾èµ–
- [ ] ç†è§£"æœ‰çŠ¶æ€"vs"æ— çŠ¶æ€"çš„åŒºåˆ«
- [ ] æ ¹æ® Resource ç±»å‹é€‰æ‹©åˆé€‚çš„ç”Ÿå‘½å‘¨æœŸ
- [ ] ä½¿ç”¨ `yield` ç®¡ç†èµ„æºçš„åˆ›å»ºå’Œæ¸…ç†
- [ ] ç†è§£ Application-scoped å’Œ Request-scoped çš„åˆ›å»º/é”€æ¯æ—¶æœº
- [ ] å®ç°å¸¦ç¼“å­˜ã€é™æµã€æ—¥å¿—çš„å®Œæ•´ç³»ç»Ÿ
- [ ] è§£é‡Šä¸ºä»€ä¹ˆæŸäº›èµ„æºè¦ç”¨ç‰¹å®šçš„ç”Ÿå‘½å‘¨æœŸ

---

## ğŸ’¡ å­¦ä¹ å»ºè®®

1. **ç”»å›¾ç†è§£**
   - ç”»å‡ºä¸åŒç”Ÿå‘½å‘¨æœŸçš„åˆ›å»ºæ—¶æœº
   - æ ‡æ³¨å“ªäº›æ˜¯å…¨å±€å…±äº«ï¼Œå“ªäº›æ˜¯è¯·æ±‚ç‹¬ç«‹
   - æ ‡æ³¨æ¸…ç†æ—¶æœº

2. **æµ‹è¯•éªŒè¯**
   - æ·»åŠ  `print()` è¯­å¥è§‚å¯Ÿåˆ›å»º/é”€æ¯
   - ä½¿ç”¨ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè¡Œä¸ºå·®å¼‚
   - æµ‹è¯•å¼‚å¸¸æƒ…å†µï¼ˆèµ„æºæ˜¯å¦æ­£ç¡®æ¸…ç†ï¼‰

3. **åœºæ™¯æ€è€ƒ**
   - çœ‹åˆ°æ–°çš„éœ€æ±‚ï¼Œæ€è€ƒåº”è¯¥ç”¨ä»€ä¹ˆç”Ÿå‘½å‘¨æœŸ
   - ä¸ºä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆåˆ©å¼Šï¼Ÿ
   - æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ¡ˆï¼Ÿ

4. **å®é™…åº”ç”¨**
   - æ€è€ƒä½ ä¹‹å‰å†™çš„ä»£ç ï¼Œå“ªäº›å¯ä»¥æ”¹ç”¨ä¾èµ–æ³¨å…¥
   - å“ªäº›èµ„æºåº”è¯¥ç”¨ yield ç®¡ç†
   - å“ªäº›åº”è¯¥ç”¨ Application-scoped

---

**æ­å–œä½ å®Œæˆè¿›é˜¶ç»ƒä¹ ï¼ç°åœ¨ä½ å·²ç»å¯ä»¥ç†Ÿç»ƒä½¿ç”¨ FastAPI çš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿäº†ã€‚**

**ä¸‹ä¸€æ­¥ï¼šå°è¯•æŒ‘æˆ˜é¡¹ç›®ï¼ˆ03_challenge_projects.mdï¼‰**
