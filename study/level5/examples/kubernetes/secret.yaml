# ========================================
# Kubernetes Secret 配置
# ========================================
# 说明：存储敏感信息（密码、密钥、证书等）
# 功能：
# 1. 环境变量注入
# 2. 挂载为文件
# 3. 镜像拉取凭证
# ========================================

# ========================================
# 方式 1: Opaque Secret（通用 Secret）
# ========================================
# 说明：最常用的 Secret 类型，用于存储任意敏感数据

apiVersion: v1
kind: Secret
metadata:
  name: fastapi-secret  # Secret 名称
  labels:
    app: fastapi-app

# Secret 类型
# Opaque: 用户定义的任意数据（默认）
type: Opaque

# ----------------------------------------
# 敏感数据（必须 base64 编码）
# ----------------------------------------
# 注意：在 Kubernetes 中，Secret 的值必须是 base64 编码
# 编码方式：echo -n "value" | base64
# 解码方式：echo "value" | base64 -d
data:
  # 数据库连接 URL
  # echo -n "postgresql://user:secretpass@db:5432/appdb" | base64
  database-url: cG9zdGdyZXNxbDovL3VzZXI6c2VjcmV0cGFzc0BkYjo1NDMyL2FwcGRi

  # 应用密钥（用于 JWT, 加密等）
  # echo -n "your-super-secret-key-change-in-production" | base64
  secret-key: eW91ci1zdXBlci1zZWNyZXQta2V5LWNoYW5nZS1pbi1wcm9kdWN0aW9u

  # Redis 密码
  # echo -n "redis-password" | base64
  redis-password: cmVkaXMtcGFzc3dvcmQ=

  # API 密钥（用于第三方服务）
  # echo -n "sk-1234567890abcdef" | base64
  api-key: c2stMTIzNDU2Nzg5MGFiY2RlZg==

  # SMTP 密码（邮件服务）
  # echo -n "smtp-password-123" | base64
  smtp-password: c210cC1wYXNzd29yZC0xMjM=

# ========================================
# 方式 2: TLS Secret（用于 HTTPS）
# ========================================
# 说明：存储 TLS 证书和私钥

# apiVersion: v1
# kind: Secret
# metadata:
#   name: fastapi-tls-secret
# type: kubernetes.io/tls  # TLS 类型
# data:
#   # TLS 证书（.crt 文件）
#   # cat tls.crt | base64
#   tls.crt: LS0tLS1CRUdJTi...（base64 编码的证书）

#   # TLS 私钥（.key 文件）
#   # cat tls.key | base64
#   tls.key: LS0tLS1CRUdJTi...（base64 编码的私钥）

# ========================================
# 方式 3: Docker Registry Secret（私有镜像仓库）
# ========================================
# 说明：用于拉取私有镜像仓库的镜像

# apiVersion: v1
# kind: Secret
# metadata:
#   name: docker-registry-secret
# type: kubernetes.io/dockerconfigjson  # Docker 配置类型
# data:
#   # Docker 配置（.dockerconfigjson）
#   # 可以使用命令创建：kubectl create secret docker-registry ...
#   .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeS5leGFtcGxlLmNvbSI6eyJ1c2VybmFtZSI6InVzZXIiLCJwYXNzd29yZCI6InBhc3MiLCJhdXRoIjoiYXNkZmdoaWprbG1ub3BxcnN0dXZ3eHl6In19fQ==

# ========================================
# 使用方式
# ========================================

# ----------------------------------------
# 方式 1: 作为环境变量
# ----------------------------------------
# 在 Deployment 中引用：
# spec:
#   containers:
#   - name: fastapi-app
#     env:
#     - name: DATABASE_URL
#       valueFrom:
#         secretKeyRef:
#           name: fastapi-secret
#           key: database-url

# ----------------------------------------
# 方式 2: 挂载为文件
# ----------------------------------------
# spec:
#   containers:
#   - name: fastapi-app
#     volumeMounts:
#     - name: secret-volume
#       mountPath: /etc/secrets  # 挂载路径
#       readOnly: true
#   volumes:
#   - name: secret-volume
#     secret:
#       secretName: fastapi-secret

# ----------------------------------------
# 方式 3: 镜像拉取凭证
# ----------------------------------------
# spec:
#   imagePullSecrets:
#   - name: docker-registry-secret
#   containers:
#   - name: fastapi-app
#     image: registry.example.com/fastapi-app:latest

# ========================================
# 完整示例：在 Deployment 中使用 Secret
# ========================================

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: fastapi-app
# spec:
#   template:
#     spec:
#       # 镜像拉取凭证
#       imagePullSecrets:
#       - name: docker-registry-secret
#
#       containers:
#       - name: fastapi-app
#         image: registry.example.com/fastapi-app:latest
#
#         # 使用 Secret 作为环境变量
#         env:
#         - name: DATABASE_URL
#           valueFrom:
#             secretKeyRef:
#               name: fastapi-secret
#               key: database-url
#         - name: SECRET_KEY
#           valueFrom:
#             secretKeyRef:
#               name: fastapi-secret
#               key: secret-key
#
#         # 挂载 Secret 为文件
#         volumeMounts:
#         - name: cert-volume
#           mountPath: /etc/certs
#           readOnly: true
#
#       volumes:
#       - name: cert-volume
#         secret:
#           secretName: fastapi-tls-secret
#           optional: false  # 必须存在

# ========================================
# 创建 Secret 的方式
# ========================================

# ----------------------------------------
# 方式 1: 从 YAML 文件创建（推荐）
# ----------------------------------------
# kubectl apply -f secret.yaml

# ----------------------------------------
# 方式 2: 从字面值创建
# ----------------------------------------
# kubectl create secret generic fastapi-secret \
#   --from-literal=database-url='postgresql://user:pass@db:5432/appdb' \
#   --from-literal=secret-key='your-secret-key' \
#   --from-literal=api-key='sk-1234567890abcdef'

# ----------------------------------------
# 方式 3: 从文件创建
# ----------------------------------------
# kubectl create secret generic fastapi-secret \
#   --from-file=database-url=./db-credentials.txt \
#   --from-file=api-key=./api-key.txt

# ----------------------------------------
# 方式 4: 从 env 文件创建
# ----------------------------------------
# kubectl create secret generic fastapi-secret \
#   --from-env-file=.env.secret

# ----------------------------------------
# 方式 5: 创建 Docker Registry Secret
# ----------------------------------------
# kubectl create secret docker-registry docker-registry-secret \
#   --docker-server=registry.example.com \
#   --docker-username=user \
#   --docker-password=password \
#   --docker-email=user@example.com

# ----------------------------------------
# 方式 6: 创建 TLS Secret
# ----------------------------------------
# kubectl create secret tls fastapi-tls-secret \
#   --cert=path/to/tls.crt \
#   --key=path/to/tls.key

# ========================================
# 使用说明
# ========================================
#
# 1. 创建 Secret：
#    kubectl apply -f secret.yaml
#
# 2. 查看 Secret：
#    kubectl get secrets
#    kubectl describe secret fastapi-secret
#    kubectl get secret fastapi-secret -o yaml
#
# 3. 查看 Secret 中的特定键（解码）：
#    kubectl get secret fastapi-secret -o jsonpath='{.data.database-url}' | base64 -d
#
# 4. 编辑 Secret（不推荐）：
#    kubectl edit secret fastapi-secret
#
# 5. 删除 Secret：
#    kubectl delete secret fastapi-secret
#
# ========================================
# Secret 加密
# ========================================
#
# 默认情况下，Kubernetes Secret 只是 base64 编码，不是加密的！
# 任何有 API 访问权限的人都能看到 Secret 的内容。
#
# 生产环境必须使用加密方案：
#
# 1. etcd 加密（静态加密）：
#    # 在 API Server 配置中启用
#    --encryption-provider-config=/etc/kubernetes/encryption-config.yaml
#
# 2. 使用外部密钥管理系统：
#    - HashiCorp Vault
#    - AWS Secrets Manager
#    - Azure Key Vault
#    - Google Secret Manager
#
# 3. 使用 Sealed Secrets（Bitnami）：
#    # 加密 Secret，只有集群能解密
#    kubeseal < secret.yaml > sealed-secret.yaml
#
# 4. 使用 External Secrets Operator：
#    # 从外部密钥管理系统同步 Secret
#    apiVersion: external-secrets.io/v1beta1
#    kind: SecretStore
#    metadata:
#      name: aws-secrets-manager
#    spec:
#      provider:
#        aws:
#          service: SecretsManager
#          region: us-east-1
#
# ========================================
# 安全最佳实践
# ========================================
#
# 1. 不要将 Secret 提交到 Git：
#    - 使用 .gitignore
#    - 使用 git-secrets 等工具防止意外提交
#    - 使用 Sealed Secrets 或 External Secrets
#
# 2. 最小权限原则：
#    - 只给 Pod 需要的 Secret
#    - 使用 RBAC 限制访问
#    - 定期轮换密钥和证书
#
# 3. 审计和监控：
#    - 审计 Secret 的访问
#    - 监控异常访问
#    - 记录密钥轮换历史
#
# 4. 使用外部密钥管理系统：
#    - 集中管理所有密钥
#    - 自动轮换密钥
#    - 审计访问日志
#    - 加密存储
#
# 5. 配置文件分离：
#    - 使用 Kustomize 的 secretGenerator
#    - 使用 Helm 的 secrets（或 external-secrets）
#    - 开发环境和生产环境使用不同的 Secret
#
# ========================================
# 常见问题
# ========================================
#
# 1. Secret 容量限制：
#    - 单个 Secret 最大 1MiB
#    - 如果需要存储大文件，使用 Persistent Volume
#
# 2. Secret 更新后 Pod 不会自动重启：
#    - 需要手动重启 Pod
#    - 或使用 Reloader 工具
#
# 3. Secret 和环境变量：
#    - Secret 作为环境变量后，更新不会生效
#    - 建议挂载为文件，支持热更新
#
# 4. base64 编码不是加密：
#    - base64 只是编码，可以轻松解码
#    - 生产环境必须使用加密方案
#
# ========================================
