# FastAPI 完整最佳实践（基于 study 笔记汇总）

## 1. 架构分层

- `Transport/API 层`：只做 HTTP 协议适配（参数校验、鉴权接入、调用服务、返回响应）。
- `Service 层`：编排用例、实现业务规则、定义事务边界。
- `Domain 层`：实体行为和领域规则，不依赖 FastAPI/数据库细节。
- `Infrastructure 层`：数据库、缓存、消息队列、外部 API 适配。

## 2. Endpoint 设计

- Endpoint 保持薄：禁止直接写复杂业务逻辑和跨聚合规则。
- 入参和出参使用类型模型（Pydantic/SQLModel），显式 `response_model`。
- 统一分页参数（`skip/limit`）和排序策略，避免无界查询。

## 3. 错误处理

- 业务错误在 `service/domain` 抛出应用异常，不直接耦合 HTTP。
- 在 FastAPI 全局异常处理器中完成异常到 HTTP 状态码映射。
- 错误响应格式保持一致；对外不泄露内部堆栈和基础设施细节。
- 优先使用语义准确状态码：`400/401/403/404/409/422/429/500/503`。

## 4. 依赖注入（DI）

- 使用 `Depends` 显式声明依赖，不用 Service Locator。
- 避免全局可变状态；请求级资源通过依赖创建和释放。
- 一个服务只注入真正需要的依赖，避免过度注入。

## 5. 数据访问与事务

- Service 依赖 Repository/数据访问抽象，而不是散落 SQL。
- 事务边界放在 Service 用例层，保证原子性和一致性。
- 数据库 schema 变更一律通过 Alembic migration 管理。

## 6. 安全

- 密钥和密码不硬编码，全部走环境变量和配置中心。
- 认证与授权分离：先认证身份，再进行权限判定。
- 错误信息避免泄露账号是否存在（防枚举、防时序攻击）。

## 7. 可观测性与运维

- 健康检查、结构化日志、错误追踪（如 Sentry）默认启用。
- 区分 `local/staging/production` 多环境配置。
- 关键外部依赖增加超时、重试、降级和熔断策略。

## 8. 测试策略

- `单元测试`：聚焦 service/domain，使用依赖替身（mock/in-memory repo）。
- `集成测试`：覆盖 API 路由、数据库交互、鉴权流程。
- `冒烟测试`：提供可自动执行脚本，覆盖关键端点回归。

## 9. 代码组织建议

- `app/api/routes/*`：路由和协议适配。
- `app/services/*`：用例编排和业务逻辑。
- `app/core/*`：配置、安全、异常、基础设施初始化。
- `app/models.py` 或 `app/models/*`：Schema/ORM 模型。

## 10. 快速评审清单（上线前）

- endpoint 中是否还有业务判断或直接 DB 访问？
- 是否所有关键业务错误都已统一映射到 HTTP 响应？
- 事务边界是否覆盖完整用例？
- 是否存在硬编码密钥或默认弱密码？
- 是否有 migration 与测试用例同步更新？
