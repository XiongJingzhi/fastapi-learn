# Nginx 配置：任务 ID 哈希路由
# 使用任务 ID（task_id）进行一致性哈希，
# 确保同一个任务的所有请求都路由到同一个节点

upstream langgraph_backend {
    # 使用 task_id 查询参数进行一致性哈希
    # 这样同一个 task_id 的请求会始终路由到同一个节点
    hash $arg_task_id consistent;
    
    # 配置后端节点
    server api-1:8000 max_fails=3 fail_timeout=30s;
    server api-2:8000 max_fails=3 fail_timeout=30s;
    server api-3:8000 max_fails=3 fail_timeout=30s;
    
    # 保持连接
    keepalive 32;
}

server {
    listen 80;
    server_name localhost;
    
    # 日志
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # LangGraph 任务执行端点（需要会话保持）
    location /api/tasks/ {
        proxy_pass http://langgraph_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 超时设置（长时间任务需要更长超时）
        proxy_connect_timeout 60s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
    }
    
    # 图列表端点（普通 API，不需要会话保持）
    location /api/graphs {
        proxy_pass http://langgraph_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://langgraph_backend;
        access_log off;
    }
    
    # Nginx 健康检查
    location /nginx-health {
        access_log off;
        return 200 "nginx-healthy\n";
        add_header Content-Type text/plain;
    }
}
